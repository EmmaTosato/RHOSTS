# RHOSTS Higher-Order Analysis - Execution Guide

## Code Structure

```
src/
├── config.json              # Analysis configuration
├── run_analysis.sh          # SLURM launch script
├── subject_134829.txt       # Subject list (1 subject)
└── higher_order/
    ├── orchestration/
    │   └── main.py          # Main entry point
    ├── nodal_strength/
    │   ├── loaders_dv.py    # DV data loading (HDF5)
    │   ├── loaders_scaffold.py  # Scaffold data loading
    │   └── utils.py         # Frame selection
    └── visualization/
        ├── utils_neuromaps_brain.py  # Brain map (local)
        └── utils_nilearn_brain.py    # Headless fallback
```

## Configuration (config.json)

```json
{
    "mode": "dv",                    // "dv" or "scaffold"
    "scenario": "all_frames",        // "all_frames", "top_percent", "single_frame"
    "percent": 0.15,                 // Percentage (for top_percent)
    "metric": "coherence",           // "coherence" (DV) or "complexity" (scaffold)
    "subjects_list_file": "/.../subjects.txt",
    "data_path_pattern_dv": "/.../lorenzo_data/{subject}/{subject}_edge_projection.hd5",
    "data_path_pattern_scaffold": "/.../lorenzo_data/{subject}/generators",
    "indicators_path_pattern": "/.../lorenzo_data/{subject}/{subject}_indicators.txt",
    "num_rois": 116,
    "output_dir": "/.../node_strengths"
}
```

### Parameters

| Parameter | Values | Description |
|-----------|--------|-------------|
| `mode` | `dv`, `scaffold` | Analysis type |
| `scenario` | `all_frames`, `top_percent`, `single_frame` | Frame selection |
| `percent` | 0.0-1.0 | Top/bottom percentage |
| `metric` | `coherence`, `complexity` | DV uses coherence (↑), scaffold uses complexity (↓) |

### Subject List

Create a `.txt` file with one subject ID per line:
```
134829
393247
745555
```

## Execution

```bash
# 1. Edit config.json with desired parameters
nano src/config.json

# 2. Submit job
sbatch src/run_analysis.sh

# 3. Monitor
squeue -u $USER

# 4. Check logs
cat Logs/nodal_strength/rhosts_run_<JOBID>.out
```

## Output

`.npy` files are generated in:
```
Output/lorenzo_data/node_strengths/
├── dv/
│   ├── dv_all_frames_5subj.npy
│   └── dv_top15pct_coherence_5subj.npy
└── scaffold/
    ├── scaffold_all_frames_5subj.npy
    └── scaffold_top15pct_complexity_5subj.npy
```

Filename is auto-generated: `{mode}_{scenario}_{n}subj.npy`

## Common Use Cases

### DV - All frames, all subjects
```json
{"mode": "dv", "scenario": "all_frames", "subjects_list_file": ".../subjects.txt"}
```

### DV - Top 15% coherence, single subject
```json
{"mode": "dv", "scenario": "top_percent", "percent": 0.15, "metric": "coherence", "subjects_list_file": ".../subject_134829.txt"}
```

### Scaffold - Top 15% complexity, all subjects
```json
{"mode": "scaffold", "scenario": "top_percent", "percent": 0.15, "metric": "complexity", "subjects_list_file": ".../subjects.txt"}
```

---

## Local Visualization (for local agent)

The `.npy` files generated by this pipeline contain nodal strength vectors (116 values, one per ROI). Brain map images must be generated on a local machine with display capabilities.

### Instructions for Local Agent

Transfer the `.npy` files to the local machine and use the existing visualization functions in `src/higher_order/visualization/utils_neuromaps_brain.py`.

#### Available Functions

**`normal_view(current_nodestrength, ...)`** - Simple brain map (lateral + medial views)

```python
from src.higher_order.visualization.utils_neuromaps_brain import normal_view
import numpy as np

data = np.load('dv_all_frames_5subj.npy')  # Shape: (116,)

fig = normal_view(
    current_nodestrength=data,
    edges=True,           # Show parcellation outlines
    cmap='RdBu_r',        # Or custom LinearSegmentedColormap
    q_thresh=0.0,         # Percentile threshold (0 = show all)
    center_cbar=True,
    xlabel=r"$\langle s_i \rangle$"
)
fig.savefig('brain_map.png', dpi=300, bbox_inches='tight')
```

**`full_view(current_nodestrength, ...)`** - Complete view (6 perspectives: lateral, medial, dorsal, ventral, anterior, posterior)

```python
from src.higher_order.visualization.utils_neuromaps_brain import full_view, compose_full_view

full_view(current_nodestrength=data, edges=True, cmap=cmap, q_thresh=0.0)
fig = compose_full_view(output_name='brain_full', save_png=True)
```

#### Key Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `current_nodestrength` | ndarray (116,) | Nodal strength values per ROI |
| `edges` | bool | Show parcellation outlines |
| `cmap` | str or Colormap | 'RdBu_r', 'custom', or LinearSegmentedColormap |
| `q_thresh` | float 0-1 | Threshold percentile (values below shown in gray) |
| `surftype` | str | 'inflated', 'veryinflated', 'midthickness' |
| `parcellation` | int | Number of parcels (100 for Schaefer100) |
| `vmin`, `vmax` | float | Manual color range |

#### Recommended Colormap

```python
from matplotlib.colors import LinearSegmentedColormap
cmap = LinearSegmentedColormap.from_list("gyr", ["#2ca25f", "#ffffbf", "#d73027"])
```
